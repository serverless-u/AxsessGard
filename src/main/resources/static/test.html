<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Testing Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        textarea {
            width: 100%;
            height: 150px;
            margin-bottom: 10px;
        }

        input, select, button {
            padding: 10px;
            margin-top: 10px;
            margin-right: 10px;
        }

        #urlInput {
            width: calc(100% - 22px); /* Adjust width to account for padding and border */
        }

        #headersInput {
            height: 100px; /* Slightly smaller for headers input */
        }
    </style>
</head>
<body>
<h1>API Testing Tool</h1>
<label for="urlInput">Enter URL:</label>
<input type="text" id="urlInput">
<script>
    document.getElementById('urlInput').value = window.location.origin + '/axsg/';
</script>
<br>
<label for="jsonInput">Enter JSON:</label>
<textarea id="jsonInput" placeholder='{"key": "value"}'></textarea>
<br>
<label for="headersInput">Enter Headers:</label>
<textarea id="headersInput" placeholder='Content-Type: application/json\nAuthorization: Bearer token'></textarea>
<script>
    document.getElementById('headersInput').value = 'X-User-Id: user1';
</script>
<br>
<label for="methodSelect">Select Method:</label>
<select id="methodSelect">
    <option value="GET">GET</option>
    <option value="POST">POST</option>
    <option value="PUT">PUT</option>
    <option value="DELETE">DELETE</option>
</select>
<br>
<button onclick="sendRequest()">Send Request</button>
<h2>Response:</h2>
<pre id="responseOutput"></pre>

<script>
    function parseHeaders(headersInput) {
        const headers = {};
        const lines = headersInput.split('\n');
        lines.forEach(line => {
            const [key, value] = line.split(': ');
            if (key && value) {
                headers[key.trim()] = value.trim();
            }
        });
        return headers;
    }

    function updateAuthorizationHeader(newAuthValue) {
        const headersInput = document.getElementById('headersInput');
        const headers = parseHeaders(headersInput.value);

        // Update or add the Authorization header
        headers['Authorization'] = `Bearer ${newAuthValue}`;

        // Convert headers back to string
        const updatedHeadersString = Object.entries(headers)
            .map(([key, value]) => `${key}: ${value}`)
            .join('\n');

        // Update the headers input field
        headersInput.value = updatedHeadersString;
    }

    function sendRequest() {
        const url = document.getElementById('urlInput').value;
        const jsonInput = document.getElementById('jsonInput').value;
        const method = document.getElementById('methodSelect').value;
        const headersInput = document.getElementById('headersInput').value;

        let headers = parseHeaders(headersInput);
        headers['Content-Type'] = 'application/json'; // Ensure Content-Type is set

        let requestOptions = {
            method: method,
            headers: headers
        };

        if (method !== 'GET') {
            try {
                requestOptions.body = JSON.stringify(JSON.parse(jsonInput));
            } catch (error) {
                alert('Invalid JSON');
                return;
            }
        }

        fetch(url, requestOptions)
            .then(response => {
                // Extract headers from the response
                const responseHeaders = Array.from(response.headers.entries());
                const headersString = responseHeaders.map(([key, value]) => `${key}: ${value}`).join('\n');

                // Check for x-request-authorization header
                const authHeader = response.headers.get('x-request-authorization');
                if (authHeader) {
                    updateAuthorizationHeader(authHeader);
                }

                const locationHeader = response.headers.get('Location');
                if (locationHeader) {
                    document.getElementById('urlInput').value = locationHeader;
                }

                // Prepare the output string
                let output = `Status: ${response.status} ${response.statusText}\n\nHeaders:\n${headersString}\n\nBody:\n`;

                // Try to parse as JSON, if fails, get as text
                return response.text().then(text => {
                    try {
                        const jsonData = JSON.parse(text);
                        output += JSON.stringify(jsonData, null, 2);
                    } catch (e) {
                        output += text;
                        // Check if URL ends with /axsg/permissions and status is 200
                        if (document.getElementById('urlInput').value.endsWith('/axsg/permissions') && response.status === 200) {
                            // Assuming the JWT is directly in the response body
                            updateAuthorizationHeader(text.trim());
                        }
                    }
                    document.getElementById('responseOutput').textContent = output;
                });
            })
            .catch(error => {
                document.getElementById('responseOutput').textContent = `Network Error: ${error.message}`;
            });
    }
</script>
</body>
</html>
